<VirtualHost *:80>
    # 替換為您的實際域名
    ServerName tourapp.ice-solution.hk
    ServerAlias www.tourapp.ice-solution.hk
    
    # 服務器管理員郵箱
    ServerAdmin info@ice-solution.hk
    
    # 日誌文件位置
    ErrorLog ${APACHE_LOG_DIR}/tourapp-error.log
    CustomLog ${APACHE_LOG_DIR}/tourapp-access.log combined
    
    # 前端靜態文件目錄（Vite 構建後的 dist 目錄）
    DocumentRoot /var/www/tourapp/frontend/dist
    
    <Directory /var/www/tourapp/frontend/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # 支持 React Router 的 SPA 路由
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # Cloudflare Flexible SSL - 處理真實 IP
    # 安裝 mod_cloudflare 或使用 mod_remoteip
    # 如果使用 mod_remoteip，需要先配置 Cloudflare IP 範圍
    <IfModule mod_remoteip.c>
        RemoteIPHeader CF-Connecting-IP
        RemoteIPTrustedProxy 173.245.48.0/20
        RemoteIPTrustedProxy 103.21.244.0/22
        RemoteIPTrustedProxy 103.22.200.0/22
        RemoteIPTrustedProxy 103.31.4.0/22
        RemoteIPTrustedProxy 141.101.64.0/18
        RemoteIPTrustedProxy 108.162.192.0/18
        RemoteIPTrustedProxy 190.93.240.0/20
        RemoteIPTrustedProxy 188.114.96.0/20
        RemoteIPTrustedProxy 197.234.240.0/22
        RemoteIPTrustedProxy 198.41.128.0/17
        RemoteIPTrustedProxy 162.158.0.0/15
        RemoteIPTrustedProxy 104.16.0.0/13
        RemoteIPTrustedProxy 104.24.0.0/14
        RemoteIPTrustedProxy 172.64.0.0/13
        RemoteIPTrustedProxy 131.0.72.0/22
        RemoteIPTrustedProxy 2400:cb00::/32
        RemoteIPTrustedProxy 2606:4700::/32
        RemoteIPTrustedProxy 2803:f800::/32
        RemoteIPTrustedProxy 2405:b500::/32
        RemoteIPTrustedProxy 2405:8100::/32
        RemoteIPTrustedProxy 2a06:98c0::/29
        RemoteIPTrustedProxy 2c0f:f248::/32
    </IfModule>
    
    # 代理後端 API 請求到 Node.js 服務
    # 假設後端運行在 localhost:5111
    ProxyPreserveHost On
    ProxyRequests Off
    
    # API 路由代理
    <LocationMatch "^/api">
        ProxyPass http://127.0.0.1:3101
        ProxyPassReverse http://127.0.0.1:3101
        ProxyPassReverse https://tourapp.ice-solution.hk
        ProxyPassReverse https://www.tourapp.ice-solution.hk
        
        # 傳遞 Cloudflare 頭部
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-For "%{CF-Connecting-IP}i"
        RequestHeader set X-Real-IP "%{CF-Connecting-IP}i"
    </LocationMatch>
    
    # 安全頭部（Cloudflare Flexible SSL）
    <IfModule mod_headers.c>
        # 強制 HTTPS（通過 Cloudflare）
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # 其他安全頭部
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        
        # 移除服務器信息
        Header unset Server
        Header unset X-Powered-By
    </IfModule>
    
    # 壓縮設置
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>
    
    # 緩存設置（靜態資源）
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        ExpiresByType application/json "access plus 0 seconds"
    </IfModule>
    
    # 禁止訪問隱藏文件
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
</VirtualHost>

